{"version":3,"sources":["../../lib/utils/index.js"],"names":["start","composeRunner","up","stop","exec","require","multiArgs","defaults","__dirname","default","module","exports","generate","composeUp","yml","cwd","process","log","console","err","error","composeStop","composeStart","cloneDB","db","media","build","config","name","root","cfs","glob","sync","nodir","ignore","map","filePath","obj","kind","ext","toLowerCase","parent","content","JSON","parse","node_env","env","NODE_ENV","docker","service","logging","session","messageBus","copy","src","deps","Array","isArray","fs","existsSync","path","join","mkdirSync","rimraf","forEach","dep","parents","push","prototype","apply","views","p","startsWith","replace","networks","working_dir","proxyService"],"mappings":"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","sourcesContent":["import glob from 'glob';\r\nimport composeRunner from 'docker-compose';\r\nimport ejs from 'ejs';\r\nimport cpy from 'cpy';\r\nimport rimraf from 'rimraf';\r\nimport {promisify} from 'util';\r\nimport fs, {readFileSync, realpathSync, writeFileSync} from 'fs';\r\nimport path, {dirname, extname, resolve} from 'path';\r\nimport {safeLoad, safeDump} from 'js-yaml';\r\n\r\nconst start = promisify(composeRunner.up);\r\nconst stop = promisify(composeRunner.stop);\r\nconst exec = promisify(require('child_process').exec, {multiArgs: true});\r\nlet defaults = require(__dirname + '/../config/Defaults').default;\r\n\r\nimport generate from './generator';\r\n\r\nmodule.exports.generate = generate;\r\n\r\nexport async function composeUp(yml) {\r\n    try {\r\n        await start({\r\n            cwd: process.cwd(),\r\n            log: true\r\n        });\r\n        console.log('docker containers started');\r\n    } catch (err) {\r\n        console.error(err);\r\n    }\r\n}\r\n\r\nexport async function composeStop(yml) {\r\n    try {\r\n        await stop({\r\n            cwd: process.cwd(),\r\n            log: true\r\n        });\r\n        console.log('docker containers stopped');\r\n    } catch (err) {\r\n        console.error(err)\r\n    }\r\n}\r\n\r\nexport async function composeStart(yml) {\r\n    try {\r\n        await exec('docker-compose start');\r\n        console.log('docker containers stopped');\r\n    } catch (err) {\r\n        console.error(err)\r\n    }\r\n}\r\n\r\nexport async function cloneDB(db, media) {\r\n    media = media || true;\r\n    try {\r\n        console.log('db cloning');\r\n        await exec(`docker-compose run --rm commander clone ${db} ${media}`);\r\n    } catch (err) {\r\n        console.error(err)\r\n    }\r\n}\r\n\r\nexport async function build(config) {\r\n    console.log(`building ${config.name}`)\r\n    await exec('yarn install', {cwd: config.root});\r\n    await exec('yarn build', {cwd: config.root});\r\n}\r\n\r\nexport default() => {\r\n    const cfs = glob.sync('**/service.config.?(js|json|yml)', {\r\n        nodir: true,\r\n        ignore: ['**/node_modules/**', 'build/**', 'lib/**', 'src/**', 'dist/**']\r\n    });\r\n    return cfs.map((filePath) => {\r\n        let obj = {\r\n            kind: ''\r\n        };\r\n\r\n        const ext = extname(filePath).toLowerCase();\r\n        const parent = dirname(filePath);\r\n        try {\r\n            if (ext === '.json') {\r\n                let content = readFileSync(realpathSync(filePath));\r\n                obj = JSON.parse(content);\r\n            } else if (ext === '.yml') {\r\n                obj = safeLoad(readFileSync(filePath), 'utf-8');\r\n            } else if (ext === '.js') {\r\n                obj = require(realpathSync('./' + filePath));\r\n            }\r\n        } catch (err) {\r\n            console.error(err);\r\n        }\r\n\r\n        console.log('found config ' + obj.name)\r\n\r\n        obj.node_env = process.env.NODE_ENV || 'dev';\r\n        obj.root = parent;\r\n\r\n        return obj;\r\n    }).map((config) => {\r\n        switch (config.kind) {\r\n            case \"service\":\r\n                {\r\n                    config = Object.assign({}, defaults.docker.service, defaults.service, config);\r\n                    config = Object.assign({\r\n                        db: Object.assign(defaults.db, {logging: defaults.logging}),\r\n                        session: Object.assign(defaults.session, {logging: defaults.logging}),\r\n                        messageBus: Object.assign(defaults.messageBus, {logging: defaults.logging}),\r\n                        logging: defaults.logging\r\n                    }, config);\r\n\r\n                    config.copy = [];\r\n\r\n                    if (!('src' in config)) {\r\n                        if ('deps' in config) {\r\n                            config.src = config.deps;\r\n                        }\r\n                    } else if ('deps' in config) {\r\n                        let deps = [config.deps];\r\n                        if (Array.isArray(config.deps)) \r\n                            deps = config.deps;\r\n                        if (!fs.existsSync(path.join(config.root, 'app', 'lib'))) \r\n                            fs.mkdirSync(path.join(config.root, 'app', 'lib'));\r\n                        if (!fs.existsSync(path.join(config.root, 'app', 'lib', 'deps'))) \r\n                            fs.mkdirSync(path.join(config.root, 'app', 'lib', 'deps'));\r\n                        else \r\n                            rimraf.sync(path.join(config.root, 'app', 'lib', 'deps') + \"/**\");\r\n                        \r\n                        deps.forEach((dep) => {\r\n                            console.log('cpy ' + dep)\r\n                            cpy(dep, path.join(config.root, 'app', 'lib', 'deps'), {\r\n                                cwd: process.cwd(),\r\n                                parents: false,\r\n                                nodir: true\r\n                            });\r\n\r\n                        });\r\n                        config.deps = ['./app/lib/deps/**']\r\n                        config\r\n                            .copy\r\n                            .push('./app/lib/deps');\r\n                    }\r\n\r\n                    if ('src' in config) {\r\n                        if (Array.isArray(config.src)) \r\n                            Array.prototype.push.apply(config.copy, config.src);\r\n                        else \r\n                            config\r\n                                .copy\r\n                                .push(config.src);\r\n                        }\r\n                    \r\n                    if ('views' in config) {\r\n                        if (Array.isArray(config.views)) \r\n                            Array.prototype.push.apply(config.copy, config.views);\r\n                        else \r\n                            config\r\n                                .copy\r\n                                .push(config.views);\r\n                        }\r\n                    \r\n                    if (typeof config.copy !== 'undefined') {\r\n                        config\r\n                            .copy\r\n                            .forEach((p) => {\r\n                                if (p.startsWith('./')) \r\n                                    p = p.replace('./', config.root + '/');\r\n                                }\r\n                            )\r\n                    }\r\n\r\n                    if ('networks' in defaults && 'internal' in defaults.networks) {\r\n                        config = Object.assign({\r\n                            networks: 'internal'\r\n                        }, config);\r\n                    }\r\n\r\n                    if (!('working_dir' in config)) {\r\n                        config.working_dir = '/usr/src/app';\r\n                    }\r\n                    break;\r\n                }\r\n            case 'proxy':\r\n                config = Object.assign({}, defaults.docker.proxyService, defaults.proxyService, config);\r\n                if ('networks' in defaults && 'proxy' in defaults.networks) {\r\n                    config = Object.assign({\r\n                        networks: 'proxy'\r\n                    }, config);\r\n                }\r\n                break;\r\n        }\r\n\r\n        return config;\r\n    });\r\n}\r\n"],"file":"index.js"}